generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model User {
  id             String        @id @default(cuid())
  name           String?
  email          String?       @unique
  emailVerified  DateTime?
  image          String?
  steamId        String?       @unique
  totalHours     Int           @default(0)
  countryCode    String?
  mainSide       String?
  survivorWeapon String?
  communication  String?
  skillLevel     String?
  bio            String?
  staffBio       String?       // Special bio for Meet the Team section (Staff only)
  
  // Premium System
  isPremium        Boolean       @default(false)
  premiumSince     DateTime?
  premiumExpiresAt DateTime?
  
  // Premium Customization
  profileTheme   String        @default("DEFAULT")  // DEFAULT, DARK, NEON, GOLD, FIRE, ICE, CUSTOM
  profileColor   String?       // Hex color for custom theme
  profileGlow    Boolean       @default(false)     // Glow effect on avatar
  profileBanner  String?       // Custom banner URL
  nameGradient   String?       // Tailwind gradient classes
  profileFrame   String?       // Avatar frame: NONE, GOLD, FIRE, ICE, ELECTRIC, RAINBOW, PREMIUM
  customTitle    String?       // Custom title under name (max 30 chars)
  
  rating         Int           @default(1000)
  rank           String        @default("Unranked")
  role           String        @default("Newcomer")
  wins           Int           @default(0)
  losses         Int           @default(0)
  winRate        Float         @default(0.0)
  teamId         String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  banCount       Int           @default(0)
  accounts         Account[]
  bans             Ban[]         @relation("Bans")
  bansGiven        Ban[]         @relation("BansGiven")
  unbansGiven      Ban[]         @relation("Unbans")
  mapVotes         MapVote[]     @relation("MapVotes")
  matchPlayers     MatchPlayer[] @relation("MatchPlayers")
  messages         Message[]     @relation("Messages")
  queueEntries     QueueEntry[]  @relation("QueueEntries")
  sessions         Session[]
  team             Team?         @relation(fields: [teamId], references: [id])
  bugReports       Report[]      @relation("BugReports")
  reportsMade      UserReport[]  @relation("ReportsMade")
  reportsReceived  UserReport[]  @relation("ReportsReceived")
  chatMutes        ChatMute[]
  medals           UserMedal[]   @relation("UserMedals")
  medalsAwarded    UserMedal[]   @relation("AwardedMedals")
  
  // Invite System
  betaAccess       Boolean       @default(false) // Default false: Private Beta (Invite Only)
  inviteUsed       InviteCode?   @relation("InviteUsedBy")
  invitesCreated   InviteCode[]  @relation("InviteCreator")
}



model Team {
  id           String   @id @default(cuid())
  name         String   @unique
  tag          String   @unique
  logoUrl      String?
  bannerUrl    String?      // Custom background image
  description  String?
  countryCodes String?
  maxMembers   Int      @default(5)
  inviteOnly   Boolean  @default(false) // Toggle for Public/Private
  ownerId      String
  rating       Int      @default(1000)
  wins         Int      @default(0)
  losses       Int      @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  members      User[]
}

model QueueEntry {
  id        String      @id @default(cuid())
  userId    String
  mmr       Int
  status    QueueStatus @default(WAITING)
  matchId   String?
  createdAt DateTime    @default(now())
  expiresAt DateTime
  isReady   Boolean     @default(false)
  match     Match?      @relation(fields: [matchId], references: [id])
  user      User        @relation("QueueEntries", fields: [userId], references: [id], onDelete: Cascade)
}

model Match {
  id             String        @id @default(cuid())
  createdAt      DateTime      @default(now())
  selectedMap    String?
  serverId       String?
  serverIp       String?
  serverPassword String?
  serverPort     Int?
  startedAt      DateTime?
  status         MatchStatus   @default(VETO)
  cancelReason   String?
  completedAt    DateTime?
  mapName        String?
  winnerTeam     String?
  teamAScore     Int           @default(0)
  teamBScore     Int           @default(0)
  mapVotes       MapVote[]
  server         GameServer?   @relation(fields: [serverId], references: [id])
  players        MatchPlayer[]
  queueEntries   QueueEntry[]
  rounds         Round[]
  messages       Message[]     @relation("MatchMessages")
}


model MatchPlayer {
  id               String             @id @default(cuid())
  matchId          String
  userId           String
  team             String             @default("TEAM_A")
  kills            Int                @default(0)
  damage           Int                @default(0)
  deaths           Int                @default(0)
  disconnectReason String?
  disconnectedAt   DateTime?
  hasJoined        Boolean            @default(false)
  headshots        Int                @default(0)
  eloAtEnd         Int?
  eloAtStart       Int?
  eloChange        Int?
  accepted         Boolean            @default(false)
  match            Match              @relation(fields: [matchId], references: [id], onDelete: Cascade)
  user             User               @relation("MatchPlayers", fields: [userId], references: [id], onDelete: Cascade)
  roundStats       PlayerRoundStats[]

  @@unique([matchId, userId])
}

model MapVote {
  id        String   @id @default(cuid())
  matchId   String
  userId    String
  map       String
  createdAt DateTime @default(now())
  match     Match    @relation(fields: [matchId], references: [id], onDelete: Cascade)
  user      User     @relation("MapVotes", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([matchId, userId])
}

model Round {
  id          String             @id @default(cuid())
  matchId     String
  roundNumber Int
  map         String
  startedAt   DateTime           @default(now())
  endedAt     DateTime?
  damageBonus Int                @default(0)
  healthBonus Int                @default(0)
  mvpSteamId  String?
  pillsBonus  Int                @default(0)
  teamScore   Int                @default(0)
  playerStats PlayerRoundStats[]
  match       Match              @relation(fields: [matchId], references: [id], onDelete: Cascade)
}

model PlayerRoundStats {
  id            String      @id @default(cuid())
  roundId       String
  matchPlayerId String
  kills         Int         @default(0)
  deaths        Int         @default(0)
  damage        Int         @default(0)
  headshots     Int         @default(0)
  common        Int         @default(0)
  steamId       String
  matchPlayer   MatchPlayer @relation(fields: [matchPlayerId], references: [id], onDelete: Cascade)
  round         Round       @relation(fields: [roundId], references: [id], onDelete: Cascade)
}

model Ban {
  id           String     @id @default(cuid())
  reason       BanReason
  description  String?    // Optional description/evidence
  duration     Int        // Duration in minutes (0 = permanent)
  matchId      String?
  createdAt    DateTime   @default(now())
  expiresAt    DateTime?
  active       Boolean    @default(true)
  
  // Who was banned
  userId       String
  user         User       @relation("Bans", fields: [userId], references: [id], onDelete: Cascade)
  
  // Who banned them (null = auto-ban)
  bannedById   String?
  bannedBy     User?      @relation("BansGiven", fields: [bannedById], references: [id])
  
  // Unban tracking
  unbannedAt   DateTime?
  unbannedById String?
  unbannedBy   User?      @relation("Unbans", fields: [unbannedById], references: [id])
}

model GameServer {
  id             String       @id @default(cuid())
  name           String
  port           Int
  rconPassword   String?
  status         ServerStatus @default(AVAILABLE)
  createdAt      DateTime     @default(now())
  ipAddress      String
  isActive       Boolean      @default(true)
  serverKey      String       @unique
  currentMatches Match[]
}

model Message {
  id        String   @id @default(cuid())
  content   String
  createdAt DateTime @default(now())
  userId    String
  user      User     @relation("Messages", fields: [userId], references: [id], onDelete: Cascade)
  matchId   String?
  match     Match?   @relation("MatchMessages", fields: [matchId], references: [id], onDelete: Cascade)
}

enum QueueStatus {
  WAITING
  MATCHED
  ACCEPTED
  DECLINED
  TIMEOUT
  READY_CHECK
}

enum MatchStatus {
  VETO
  READY
  IN_PROGRESS
  PAUSED
  COMPLETED
  CANCELLED
  READY_CHECK
  WAITING_FOR_PLAYERS
}

enum BanReason {
  AFK_ACCEPT
  NO_JOIN
  CRASH
  MANUAL
  TROLLING
  CHEATING
}


model Report {
  id        String     @id @default(cuid())
  userId    String
  user      User       @relation("BugReports", fields: [userId], references: [id])
  type      ReportType
  title     String
  content   String
  evidence  String?
  target    String?    // Targeted player SteamID or Name (optional)
  status    String     @default("OPEN")
  createdAt DateTime   @default(now())
}


enum ReportType {
  BUG
  PLAYER
  FEEDBACK
}

enum ServerStatus {
  AVAILABLE
  IN_USE
  OFFLINE
  MAINTENANCE
}

// ============ ADMIN PANEL MODELS ============

model Announcement {
  id        String    @id @default(cuid())
  title     String
  content   String
  type      String    @default("INFO") // INFO, WARNING, MAINTENANCE
  location  String    @default("HOME") // HOME, PLAY, GLOBAL
  active    Boolean   @default(true)
  createdAt DateTime  @default(now())
  expiresAt DateTime?
}

model SiteContent {
  id        String   @id @default(cuid())
  key       String   @unique // e.g., "home_hero_title", "home_hero_subtitle"
  content   String
  updatedAt DateTime @updatedAt
}

model ChatMute {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  reason    String?
  mutedBy   String?  // Admin who muted
  expiresAt DateTime
  createdAt DateTime @default(now())
}

model UserReport {
  id          String       @id @default(cuid())
  reason      ReportReason
  description String?
  status      ReportStatus @default(PENDING)
  createdAt   DateTime     @default(now())
  
  reporterId  String
  reporter    User         @relation("ReportsMade", fields: [reporterId], references: [id], onDelete: Cascade)
  
  reportedId  String
  reported    User         @relation("ReportsReceived", fields: [reportedId], references: [id], onDelete: Cascade)
  
  matchId     String?      // Optional: link to specific match where incident occurred
}


enum ReportReason {
  CHEATING
  TROLLING
}

enum ReportStatus {
  PENDING
  REVIEWED
  ACTION_TAKEN
  DISMISSED
}

enum MedalRarity {
  COMMON
  RARE
  EPIC
  LEGENDARY
}

model Medal {
  id          String      @id @default(cuid())
  name        String
  description String
  icon        String      // Emoji or icon name
  color       String      @default("#22c55e") // Hex color
  rarity      MedalRarity @default(COMMON)
  createdAt   DateTime    @default(now())
  createdBy   String      // Owner ID
  
  awards      UserMedal[]
}

model UserMedal {
  id        String   @id @default(cuid())
  userId    String
  medalId   String
  awardedBy String   // Owner ID who awarded
  note      String?  // Optional note from owner
  awardedAt DateTime @default(now())
  
  user      User     @relation("UserMedals", fields: [userId], references: [id], onDelete: Cascade)
  medal     Medal    @relation(fields: [medalId], references: [id], onDelete: Cascade)
  awarder   User     @relation("AwardedMedals", fields: [awardedBy], references: [id])
  
  @@unique([userId, medalId]) // One medal per user
}

// ============ INVITE SYSTEM ============

model InviteCode {
  id        String   @id @default(cuid())
  code      String   @unique
  isUsed    Boolean  @default(false)
  
  usedBy    String?  @unique
  usedAt    DateTime?
  
  createdBy String
  createdAt DateTime @default(now())
  
  user      User?    @relation("InviteUsedBy", fields: [usedBy], references: [id])
  creator   User     @relation("InviteCreator", fields: [createdBy], references: [id])
}
